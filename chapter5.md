# Chapter 5: 信号处理与时序控制

激光雷达的测距精度和性能很大程度上取决于其信号处理和时序控制系统。本章将深入探讨时间数字转换技术、波形处理算法以及同步机制，这些是实现高精度测距的关键技术。我们将通过详细的计算实例来理解各种技术的原理和性能极限。

## 5.1 时间数字转换(TDC)

时间数字转换器是激光雷达系统的核心组件，负责将光脉冲的飞行时间转换为数字信号。TDC的性能直接决定了激光雷达的测距精度。

### 5.1.1 TDC基本原理

TDC的基本功能是测量两个事件之间的时间间隔。在激光雷达中，这两个事件分别是激光发射脉冲（START）和接收到的回波脉冲（STOP）。

时间分辨率（LSB - Least Significant Bit）定义为：
$$t_{LSB} = \frac{T_{ref}}{2^N}$$

其中：
- $T_{ref}$ 是参考时钟周期
- $N$ 是TDC的位数

**计算实例1：基本TDC分辨率**

假设使用100MHz参考时钟，12位TDC：
- $T_{ref} = 1/100MHz = 10ns$
- $t_{LSB} = 10ns / 2^{12} = 10ns / 4096 = 2.44ps$

对应的距离分辨率：
$$\Delta d = \frac{c \cdot t_{LSB}}{2} = \frac{3 \times 10^8 \times 2.44 \times 10^{-12}}{2} = 0.366mm$$

### 5.1.2 游标法（Vernier）原理

游标法通过两个略有差异的延迟链来提高时间分辨率：

$$t_{measured} = n_1 T_1 - n_2 T_2$$

其中：
- $T_1$ 和 $T_2$ 是两条延迟链的单元延迟
- $n_1$ 和 $n_2$ 是各自的计数值

游标分辨率为：
$$t_{resolution} = |T_1 - T_2|$$

**计算实例2：游标TDC设计**

设计参数：
- $T_1 = 100ps$（快链）
- $T_2 = 110ps$（慢链）
- 游标分辨率 = $110ps - 100ps = 10ps$

测量范围：需要N个延迟单元
$$T_{range} = N \times T_1 = N \times 100ps$$

若需要1μs测量范围：
$$N = \frac{1000ns}{100ps} = 10,000$$

### 5.1.3 时间内插技术

时间内插技术用于进一步提高分辨率，通过测量信号在一个时钟周期内的精确位置。

**TAC（Time-to-Amplitude Converter）方法：**
1. 将时间间隔转换为电压
2. 用ADC数字化电压值

充电电流方程：
$$V(t) = \frac{I \cdot t}{C}$$

时间分辨率：
$$\Delta t = \frac{C \cdot V_{LSB}}{I}$$

**计算实例3：TAC设计**

参数设置：
- 充电电流 $I = 1mA$
- 电容 $C = 10pF$
- ADC: 10位，满量程3.3V
- $V_{LSB} = 3.3V / 1024 = 3.22mV$

时间分辨率：
$$\Delta t = \frac{10 \times 10^{-12} \times 3.22 \times 10^{-3}}{1 \times 10^{-3}} = 32.2ps$$

### 5.1.4 多级TDC架构

为了兼顾大动态范围和高分辨率，常采用粗-细两级结构：

1. **粗计数器**：使用系统时钟计数
2. **细TDC**：测量时钟边沿内的时间

总测量时间：
$$t_{total} = N_{coarse} \times T_{clk} + t_{fine}$$

**计算实例4：两级TDC系统**

系统参数：
- 系统时钟：250MHz（$T_{clk} = 4ns$）
- 粗计数器：16位
- 细TDC：游标法，25ps分辨率

性能分析：
- 最大测量范围：$2^{16} \times 4ns = 262.144μs$
- 对应最大距离：$\frac{3 \times 10^8 \times 262.144 \times 10^{-6}}{2} = 39.32km$
- 距离分辨率：$\frac{3 \times 10^8 \times 25 \times 10^{-12}}{2} = 3.75mm$

### 5.1.5 TDC非线性校正

实际TDC存在微分非线性（DNL）和积分非线性（INL）：

**DNL定义：**
$$DNL[i] = \frac{t_{actual}[i] - t_{ideal}}{t_{LSB}} - 1$$

**INL定义：**
$$INL[i] = \sum_{j=0}^{i} DNL[j]$$

校正方法：
1. 建立查找表（LUT）
2. 多项式拟合

**计算实例5：非线性校正**

测量得到的非线性数据：
- 理想LSB = 25ps
- 实测某通道：24.5ps, 25.2ps, 24.8ps, 25.5ps

DNL计算：
- $DNL[0] = \frac{24.5}{25} - 1 = -0.02$
- $DNL[1] = \frac{25.2}{25} - 1 = 0.008$
- $DNL[2] = \frac{24.8}{25} - 1 = -0.008$
- $DNL[3] = \frac{25.5}{25} - 1 = 0.02$

最大DNL = 0.02 LSB，满足 < 0.5 LSB的要求。

### 5.1.6 多通道TDC设计

对于多线激光雷达，需要多通道TDC：

**资源共享架构：**
- 共享粗计数器
- 每通道独立细TDC

通道间串扰分析：
$$Crosstalk = 20\log_{10}\left(\frac{V_{coupled}}{V_{signal}}\right) dB$$

**计算实例6：16通道TDC系统**

设计要求：
- 16个独立测量通道
- 每通道50ps分辨率
- 通道间串扰 < -40dB

功耗估算：
- 单通道TDC功耗：20mW
- 共享逻辑：50mW
- 总功耗：$16 \times 20mW + 50mW = 370mW$

面积估算（65nm CMOS）：
- 单通道面积：0.05mm²
- 总面积：$16 \times 0.05 + 0.1 = 0.9mm²$

## 5.2 波形采样与处理

激光雷达接收到的回波信号包含丰富的信息，通过适当的波形处理可以提高测距精度、增强多目标分辨能力，并提取目标的反射特性。

### 5.2.1 全波形数字化

全波形数字化记录整个回波脉冲的形状，而不仅仅是检测阈值触发时刻。

**SNR改善原理：**
对于N个采样点的平均，SNR改善为：
$$SNR_{improved} = SNR_{single} \times \sqrt{N}$$

**采样定理要求：**
$$f_s > 2 \times f_{max}$$

其中$f_{max}$是信号最高频率成分。

**计算实例7：采样率选择**

激光脉冲参数：
- 脉冲宽度（FWHM）：10ns
- 近似带宽：$BW \approx \frac{0.35}{\tau_{rise}} \approx \frac{0.35}{4ns} = 87.5MHz$

采样要求：
- 最小采样率：$f_s > 2 \times 87.5MHz = 175MHz$
- 实际选择：$f_s = 1GHz$（过采样提高精度）

每个脉冲采样点数：
- 观察窗口：100ns（对应15m距离）
- 采样点数：$100ns \times 1GHz = 100$个点

### 5.2.2 脉冲检测算法

**1. 阈值检测法**

简单阈值：
$$t_{detect} = \min\{t : V(t) > V_{threshold}\}$$

存在的问题：
- 幅度变化导致时间游走（walk error）
- 噪声引起的误触发

**2. 恒比定时（CFD - Constant Fraction Discriminator）**

CFD通过检测信号达到峰值固定比例的时刻来消除幅度依赖性：

$$V_{CFD}(t) = V(t) - f \cdot V(t - t_d)$$

其中：
- $f$ 是分数（通常0.2-0.5）
- $t_d$ 是延迟时间

过零点检测：
$$t_{zero} : V_{CFD}(t_{zero}) = 0$$

**计算实例8：CFD参数优化**

信号参数：
- 上升时间：3ns
- 脉冲宽度：10ns

CFD设计：
- 选择 $f = 0.3$
- 延迟 $t_d = 2ns$（小于上升时间）

时间精度分析：
- 信号斜率在30%幅度处：$\frac{dV}{dt} = \frac{0.7V_{peak}}{2ns} = 0.35V_{peak}/ns$
- 噪声引起的时间抖动：$\sigma_t = \frac{\sigma_{noise}}{dV/dt} = \frac{0.01V_{peak}}{0.35V_{peak}/ns} = 28.6ps$

**3. 数字CFD实现**

数字域实现CFD：
```
CFD[n] = x[n] - f × x[n-k]
```

其中$k = \lfloor t_d \times f_s \rfloor$

**计算实例9：数字CFD设计**

参数：
- 采样率：1GHz
- 延迟：2ns → k = 2
- 分数：f = 0.3

插值提高精度：
使用线性插值找到精确过零点：
$$t_{zero} = t_n + \frac{CFD[n]}{CFD[n] - CFD[n+1]} \times T_s$$

### 5.2.3 多回波处理

激光穿过半透明物体（如树叶、玻璃）或遇到多个目标时会产生多个回波。

**回波分离条件：**
两个脉冲可分辨的最小时间间隔：
$$\Delta t_{min} \approx \tau_{pulse}$$

对应的距离分辨率：
$$\Delta d_{min} = \frac{c \times \tau_{pulse}}{2}$$

**计算实例10：多回波能力分析**

系统参数：
- 激光脉宽：10ns
- 最小可分辨距离：$\Delta d = \frac{3 \times 10^8 \times 10 \times 10^{-9}}{2} = 1.5m$

实际场景：
- 第一回波：树叶边缘，距离50m
- 第二回波：树干，距离52m
- 间隔2m > 1.5m，可以分辨

**多回波检测算法：**

1. **峰值检测法**
   - 寻找局部最大值
   - 判据：$V[n] > V[n-1]$ 且 $V[n] > V[n+1]$

2. **高斯拟合法**
   
   多高斯模型：
   $$V(t) = \sum_{i=1}^{N} A_i \exp\left(-\frac{(t-t_i)^2}{2\sigma_i^2}\right) + n(t)$$

   使用最小二乘法求解参数。

**计算实例11：双回波分离**

观测数据：两个部分重叠的高斯脉冲
- 脉冲1：$A_1 = 1.0V$, $t_1 = 50ns$, $\sigma_1 = 4ns$
- 脉冲2：$A_2 = 0.6V$, $t_2 = 58ns$, $\sigma_2 = 4ns$

分离度分析：
- 时间间隔：$\Delta t = 8ns = 2\sigma$
- 按照瑞利判据，可以分辨（需要$\Delta t > 1.22\sigma$）

### 5.2.4 波形特征提取

除了测距，回波波形还包含目标特性信息：

**1. 脉冲宽度**
反映目标的深度信息：
$$\Delta d_{target} = \frac{c \times (\tau_{received} - \tau_{transmitted})}{2}$$

**2. 脉冲幅度**
与目标反射率和距离相关：
$$A_{received} = A_{transmitted} \times \frac{\rho \times A_{receiver}}{\pi R^2} \times \eta_{atm} \times \eta_{sys}$$

**3. 脉冲形状**
表征表面粗糙度和倾斜角。

**计算实例12：目标特性提取**

测量数据：
- 发射脉宽：10ns
- 接收脉宽：15ns
- 目标距离：100m

分析：
1. 目标深度：$\Delta d = \frac{3 \times 10^8 \times 5 \times 10^{-9}}{2} = 0.75m$

2. 如果已知系统参数，可以估算反射率：
   - 接收功率：-40dBm
   - 发射功率：10dBm
   - 系统损耗：-3dB
   - 大气衰减（100m）：-0.5dB
   
   反射率估算：
   $$\rho \approx \frac{P_r \times \pi R^2}{P_t \times A_r \times \eta} = 0.18$$（18%反射率）

### 5.2.5 实时处理要求

**处理延迟预算：**

1. ADC转换：~10ns
2. 数字滤波：~50ns
3. 峰值检测：~20ns
4. 时间计算：~10ns
5. 总延迟：~90ns

**计算实例13：数据率估算**

32线激光雷达：
- 每线脉冲重复率：50kHz
- 每脉冲采样点：100个
- 每采样点：12位

数据率：
$$R = 32 \times 50kHz \times 100 \times 12bit = 192Mbps$$

考虑多回波（最多3个）：
$$R_{max} = 192Mbps \times 3 = 576Mbps$$

### 5.2.6 噪声抑制技术

**1. 匹配滤波**

匹配滤波器的冲激响应：
$$h(t) = s^*(-t)$$

其中$s(t)$是期望信号波形。

SNR增益：
$$G_{MF} = \sqrt{\frac{2E}{N_0}}$$

**2. 累积平均**

对M次测量求平均：
$$\bar{x} = \frac{1}{M}\sum_{i=1}^{M} x_i$$

噪声降低：
$$\sigma_{\bar{x}} = \frac{\sigma_x}{\sqrt{M}}$$

**计算实例14：噪声抑制效果**

系统参数：
- 单次测量SNR = 10dB（10:1）
- 累积次数M = 16

改善后：
- $SNR_{improved} = 10 \times \sqrt{16} = 40$
- 以dB表示：$10\log_{10}(40) = 16dB$

测距精度提升：
- 单次测量精度：10cm
- 16次平均后：$\frac{10cm}{\sqrt{16}} = 2.5cm$

## 5.3 相位同步与时钟

精确的时序控制是激光雷达系统的基础。时钟抖动、相位噪声和同步误差都会直接影响测距精度。

### 5.3.1 时钟系统架构

**主时钟要求：**
- 频率稳定度：< ±10ppm
- 相位噪声：< -120dBc/Hz @ 1kHz
- 时钟抖动：< 1ps RMS

**时钟分配网络：**
使用时钟树结构，确保各模块时钟相位一致：
$$\phi_{skew} = \Delta L \times \sqrt{\epsilon_r} / c$$

其中：
- $\Delta L$ 是路径长度差
- $\epsilon_r$ 是PCB介电常数

**计算实例15：时钟偏斜分析**

PCB设计参数：
- 最大路径差：50mm
- FR4介电常数：$\epsilon_r = 4.4$
- 光速：$c = 3 \times 10^8 m/s$

时钟偏斜：
$$\phi_{skew} = \frac{50 \times 10^{-3} \times \sqrt{4.4}}{3 \times 10^8} = 350ps$$

对于1GHz时钟（周期1ns），相位偏差：
$$\Delta\phi = \frac{350ps}{1000ps} \times 360° = 126°$$

这个偏斜过大，需要使用等长布线或延迟补偿。

### 5.3.2 扫描相位延迟补偿

机械扫描系统中，激光发射和接收之间存在扫描运动，需要补偿。

**运动补偿公式：**
$$\Delta\phi = \omega \times t_{flight}$$

其中：
- $\omega$ 是扫描角速度
- $t_{flight}$ 是光飞行时间

**计算实例16：旋转扫描补偿**

系统参数：
- 扫描速度：10Hz（600rpm）
- 目标距离：100m
- 光飞行时间：$t = \frac{2 \times 100m}{3 \times 10^8 m/s} = 667ns$

角度偏移：
$$\Delta\theta = 10Hz \times 360° \times 667 \times 10^{-9} = 0.0024°$$

这个偏移很小，但对于高精度应用仍需补偿。

对于0.1°角分辨率系统：
- 相对误差：$\frac{0.0024°}{0.1°} = 2.4\%$

### 5.3.3 PLL锁相环设计

PLL用于生成稳定的高频时钟和同步多个时钟域。

**基本PLL传递函数：**
$$H(s) = \frac{K_{pd} K_{vco} F(s)}{s + K_{pd} K_{vco} F(s)}$$

其中：
- $K_{pd}$ 是鉴相器增益
- $K_{vco}$ 是VCO增益
- $F(s)$ 是环路滤波器

**环路带宽设计：**
$$f_{BW} = \frac{K_{pd} K_{vco}}{2\pi}$$

**计算实例17：PLL参数设计**

目标规格：
- 输入参考：10MHz
- 输出频率：1GHz（倍频100）
- 相位噪声：< -100dBc/Hz @ 10kHz

设计参数：
- $K_{pd} = 0.5V/rad$
- $K_{vco} = 200MHz/V$
- 环路带宽：$f_{BW} = \frac{0.5 \times 200 \times 10^6}{2\pi} = 15.9MHz$

实际选择$f_{BW} = 100kHz$以获得更好的噪声抑制。

**相位噪声传递：**
- 低频（< $f_{BW}$）：跟随参考时钟
- 高频（> $f_{BW}$）：由VCO决定

### 5.3.4 时钟抖动对测距的影响

时钟抖动直接转化为测距误差：
$$\sigma_{range} = \frac{c \cdot \sigma_{clock}}{2}$$

**总抖动分析：**
$$\sigma_{total} = \sqrt{\sigma_{ref}^2 + \sigma_{PLL}^2 + \sigma_{dist}^2}$$

**计算实例18：抖动预算分配**

系统要求：测距精度1cm

时间抖动要求：
$$\sigma_{clock} = \frac{2 \times 0.01m}{3 \times 10^8 m/s} = 67ps$$

抖动预算分配：
- 参考时钟：20ps
- PLL贡献：50ps
- 分配网络：30ps

验证：
$$\sigma_{total} = \sqrt{20^2 + 50^2 + 30^2} = 62ps < 67ps$$ ✓

### 5.3.5 多通道同步

多线激光雷达需要精确的通道间同步。

**同步方案：**
1. 共同触发
2. 延迟链校准
3. 相位插值

**通道间延迟校准：**
使用已知目标进行校准：
$$\Delta t_{cal} = t_{measured} - t_{expected}$$

**计算实例19：16通道同步设计**

要求：
- 通道间同步精度：< 100ps
- 触发扇出：16路

延迟匹配：
- PCB走线匹配：±5mm（±25ps）
- 芯片内延迟差：±50ps
- 温度漂移：±25ps

总误差：
$$\sigma_{sync} = \sqrt{25^2 + 50^2 + 25^2} = 61ps < 100ps$$ ✓

### 5.3.6 时间戳系统

为数据融合和运动补偿，需要精确时间戳。

**时间戳分辨率：**
$$\Delta t_{stamp} = \frac{1}{f_{counter}}$$

**GPS同步（可选）：**
- 1PPS精度：< 20ns
- 时间传递精度：< 100ns

**计算实例20：时间戳系统设计**

系统要求：
- 时间戳分辨率：1μs
- 长期稳定度：< 1ms/天

设计：
- 计数器频率：1MHz
- 晶振稳定度：±10ppm
- 每天漂移：$10 \times 10^{-6} \times 86400s = 0.864s$

需要定期GPS校准以保持长期精度。

### 5.3.7 死区时间管理

SPAD探测器的死区时间影响最大计数率。

**死区时间影响：**
$$R_{observed} = \frac{R_{true}}{1 + R_{true} \times \tau_{dead}}$$

**计算实例21：死区时间补偿**

探测器参数：
- 死区时间：$\tau_{dead} = 50ns$
- 真实光子率：$R_{true} = 10MHz$

观测到的计数率：
$$R_{observed} = \frac{10 \times 10^6}{1 + 10 \times 10^6 \times 50 \times 10^{-9}} = 6.67MHz$$

计数损失：33%

补偿公式：
$$R_{true} = \frac{R_{observed}}{1 - R_{observed} \times \tau_{dead}}$$